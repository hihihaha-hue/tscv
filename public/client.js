//======================================================================
// THá»¢ SÄ‚N Cá»” Váº¬T - CLIENT LOGIC (FIX Lá»–I HIá»‚N THá»Š VAI TRÃ’ CUá»I CÃ™NG)
//======================================================================

const socket = io();

// --- I. DOM Elements ---
const screens = { home: document.getElementById('home-screen'), room: document.getElementById('room-screen'), game: document.getElementById('game-screen') };
const homeElements = { createRoomBtn: document.getElementById('create-room-btn'), joinRoomBtn: document.getElementById('join-room-btn'), roomCodeInput: document.getElementById('room-code-input'), nameInput: document.getElementById('player-name-input') };
const roomElements = { roomCodeDisplay: document.getElementById('room-code-display'), playerList: document.getElementById('player-list'), hostControls: document.getElementById('host-controls'), addBotBtn: document.getElementById('add-bot-btn'), startGameBtn: document.getElementById('start-game-btn') };
const gameElements = { roundIndicator: document.getElementById('current-round'), decreeDisplay: document.getElementById('decree-display'), playersContainer: document.getElementById('players-container'), phaseTitle: document.getElementById('phase-title'), actionControls: document.getElementById('action-controls'), messageArea: document.getElementById('message-area'), roleDisplay: document.getElementById('role-display') };

// --- II. Client State ---
let state = { myId: null, currentRoomCode: null, currentHostId: null, players: [], gamePhase: null, countdownTimer: null, myRole: null };

// --- III. Helper Functions ---
function showScreen(screenName) { Object.keys(screens).forEach(key => screens[key].style.display = (key === screenName) ? 'block' : 'none'); }
function logMessage(type, message) { const p = document.createElement('p'); p.className = type; p.innerHTML = message; gameElements.messageArea.prepend(p); }
function playSound(soundFile) { try { new Audio(`/assets/sounds/${soundFile}`).play(); } catch (e) { console.warn(`KhÃ´ng thá»ƒ phÃ¡t Ã¢m thanh: ${soundFile}`); } }
function createModal(title, contentHTML) { const e = document.querySelector('.modal-overlay'); if (e) e.remove(); const m = document.createElement('div'); m.className = 'modal-overlay'; const c = document.createElement('div'); c.className = 'modal-content'; c.innerHTML = `<h2>${title}</h2>${contentHTML}`; m.appendChild(c); document.body.appendChild(m); }
function closeModal() { const e = document.querySelector('.modal-overlay'); if (e) e.remove(); }
function getChoiceClass(choice) { switch (choice) { case 'Giáº£i MÃ£': return 'loyal-text'; case 'PhÃ¡ Hoáº¡i': return 'corrupt-text'; case 'Quan SÃ¡t': return 'blank-text'; default: return 'info'; } }

// --- IV. Render Functions ---
function renderPlayerList() { roomElements.playerList.innerHTML = ''; const isHost = state.myId === state.currentHostId; state.players.forEach(p => { const li = document.createElement('li'); let text = `<span>${p.name}</span>`; let controls = ''; if (p.id === state.myId) text += ' <em>(Báº¡n)</em>'; if (p.id === state.currentHostId) text += ' <strong class="host-tag">[TrÆ°á»Ÿng ÄoÃ n]</strong>'; if (p.disconnected) text += ' <span class="disconnected-tag">(Máº¥t tÃ­ch)</span>'; if (isHost && p.id !== state.myId) { controls = `<button class="kick-btn" onclick="kickPlayer('${p.id}')">Trá»¥c Xuáº¥t</button>`; } li.innerHTML = `<div>${text}</div><div>${controls}</div>`; if (p.isBot) li.classList.add('bot'); roomElements.playerList.appendChild(li); }); roomElements.hostControls.style.display = isHost ? 'block' : 'none'; if (roomElements.startGameBtn) { roomElements.startGameBtn.disabled = state.players.length < 2; } }
function renderPlayerCards() { gameElements.playersContainer.innerHTML = ''; state.players.forEach(player => { const card = document.createElement('div'); card.className = 'player-card'; card.id = `player-card-${player.id}`; card.innerHTML = `<h3>${player.name}</h3><p>Tiáº¿n Äá»™: <span class="player-score">${player.score}</span></p><div class="chosen-action-wrapper"><p class="chosen-action info">Äang hÃ nh Ä‘á»™ng...</p></div>`; if (player.disconnected) card.classList.add('disconnected'); gameElements.playersContainer.appendChild(card); }); }

// --- V. EVENT LISTENERS ---
homeElements.createRoomBtn.addEventListener('click', () => socket.emit('createRoom', { name: homeElements.nameInput.value }));
homeElements.joinRoomBtn.addEventListener('click', () => { const code = homeElements.roomCodeInput.value; if (code) socket.emit('joinRoom', { roomCode: code, name: homeElements.nameInput.value }); });
roomElements.addBotBtn.addEventListener('click', () => socket.emit('addBot', state.currentRoomCode));
roomElements.startGameBtn.addEventListener('click', () => socket.emit('startGame', state.currentRoomCode));

// --- VI. SOCKET.IO EVENT HANDLERS ---
socket.on('connect', () => { state.myId = socket.id; showScreen('home'); });
socket.on('roomError', msg => alert(`Lá»—i: ${msg}`));
socket.on('joinedRoom', data => { state.currentRoomCode = data.roomCode; state.currentHostId = data.hostId; state.players = data.players; roomElements.roomCodeDisplay.textContent = state.currentRoomCode; showScreen('room'); renderPlayerList(); });
socket.on('updatePlayerList', (players, hostId) => { state.players = players; state.currentHostId = hostId; renderPlayerList(); });
socket.on('kicked', () => { alert("Báº¡n Ä‘Ã£ bá»‹ TrÆ°á»Ÿng ÄoÃ n trá»¥c xuáº¥t!"); showScreen('home'); });
socket.on('gameStarted', () => { showScreen('game'); gameElements.messageArea.innerHTML = ''; if (gameElements.roleDisplay) gameElements.roleDisplay.style.display = 'none'; });

socket.on('yourRoleIs', (role) => {
    console.log('[CLIENT-DEBUG] ÄÃ£ nháº­n Ä‘Æ°á»£c vai trÃ²:', role);
    state.myRole = role;
    const roleDisplay = gameElements.roleDisplay;
    // [Sá»¬A Lá»–I á» ÄÃ‚Y] - Kiá»ƒm tra láº¡i biáº¿n cho cháº¯c cháº¯n vÃ  thÃªm log lá»—i chi tiáº¿t
    if (roleDisplay && role && role.name && role.description) {
        roleDisplay.innerHTML = `
            <h4>ThiÃªn Má»‡nh Cá»§a Báº¡n</h4>
            <strong>${role.name}</strong>
            <p>${role.description}</p>
        `;
        roleDisplay.style.display = 'block';
    } else {
        console.error("[CLIENT-ERROR] KhÃ´ng thá»ƒ hiá»ƒn thá»‹ vai trÃ². Dá»¯ liá»‡u hoáº·c pháº§n tá»­ HTML bá»‹ thiáº¿u.", { receivedRole: role, roleDisplayElement: roleDisplay });
    }
});

socket.on('newRound', data => { state.gamePhase = 'choice'; state.players = data.players; gameElements.roundIndicator.textContent = data.roundNumber; gameElements.phaseTitle.textContent = 'HÃ nh Äá»™ng Trong ÄÃªm'; gameElements.decreeDisplay.style.display = 'none'; clearInterval(state.countdownTimer); renderPlayerCards(); let phaseHTML = `<div id="timer-display">${data.duration}</div><div id="player-choice-buttons-wrapper"><button class="choice-buttons loyal" onclick="sendPlayerChoice('Giáº£i MÃ£')">Giáº£i MÃ£</button><button class="choice-buttons corrupt" onclick="sendPlayerChoice('PhÃ¡ Hoáº¡i')">PhÃ¡ Hoáº¡i</button><button class="choice-buttons blank" onclick="sendPlayerChoice('Quan SÃ¡t')">Quan SÃ¡t</button></div>`; gameElements.actionControls.innerHTML = phaseHTML; logMessage('info', `--- ÄÃªm thá»© ${data.roundNumber} báº¯t Ä‘áº§u! ---`); let t = data.duration; state.countdownTimer = setInterval(() => { t--; const timerEl = document.getElementById('timer-display'); if (timerEl) timerEl.textContent = t >= 0 ? t : 0; if (t < 0) clearInterval(state.countdownTimer); }, 1000); });
socket.on('playerChose', playerId => { const card = document.getElementById(`player-card-${playerId}`); if (card) { const a = card.querySelector('.chosen-action'); a.textContent = 'âœ… ÄÃ£ hÃ nh Ä‘á»™ng'; a.className = 'chosen-action info'; } });
socket.on('decreeRevealed', data => { playSound('decree.mp3'); let decreeHTML = `<h3>ğŸ“œ Tiáº¿ng Vá»ng Cá»§a Äá»n Thá» ğŸ“œ</h3>`; data.decrees.forEach(decree => { decreeHTML += `<div class="decree-item"><p class="decree-title warning">${decree.name}</p><p class="decree-description">${decree.description}</p></div>`; }); gameElements.decreeDisplay.innerHTML = decreeHTML; gameElements.decreeDisplay.style.display = 'block'; logMessage('warning', `ğŸ“œ **${data.drawerName}** Ä‘Ã£ nghe tháº¥y má»™t Tiáº¿ng Vá»ng!`); });
socket.on('chaosPhaseStarted', data => { state.gamePhase = 'chaos'; gameElements.phaseTitle.textContent = "Giá» HoÃ ng HÃ´n"; const totalPlayers = state.players.filter(p => !p.disconnected).length; let h = `<div id="timer-display">${data.duration}</div><div class="chaos-actions"><button onclick="showTargetSelection('Váº¡ch Tráº§n')">Váº¡ch Tráº§n</button><button onclick="showTargetSelection('Phá»‘i Há»£p')">Phá»‘i Há»£p</button></div><button id="skip-chaos-btn" class="skip-button" onclick="voteToSkipChaos()">Nghá»‰ NgÆ¡i <span id="skip-vote-count">(0/${totalPlayers})</span></button>`; gameElements.actionControls.innerHTML = h; let t = data.duration; clearInterval(state.countdownTimer); state.countdownTimer = setInterval(() => { t--; const timerEl = document.getElementById('timer-display'); if (timerEl) timerEl.textContent = t >= 0 ? t : 0; if (t < 0) clearInterval(state.countdownTimer); }, 1000); });
socket.on('chaosActionResolved', data => { state.gamePhase = 'reveal_pending'; clearInterval(state.countdownTimer); gameElements.actionControls.innerHTML = ''; gameElements.phaseTitle.textContent = "BÃ¬nh minh lÃªn..."; logMessage('warning', data.message); closeModal(); });
socket.on('updateSkipVoteCount', (count, total) => { const countEl = document.getElementById('skip-vote-count'); if(countEl) countEl.textContent = `(${count}/${total})`; });
socket.on('updateScores', updatedPlayers => { updatedPlayers.forEach(p => { const scoreEl = document.querySelector(`#player-card-${p.id} .player-score`); if (scoreEl) scoreEl.textContent = p.score; }); });
socket.on('roundResult', data => { state.gamePhase = 'reveal'; gameElements.phaseTitle.textContent = 'Káº¿t Quáº£ ÄÃªm'; gameElements.actionControls.innerHTML = ''; const { finalVoteCounts: counts } = data; logMessage('info', `Káº¿t quáº£: ${counts['Giáº£i MÃ£'] || 0} Giáº£i MÃ£, ${counts['PhÃ¡ Hoáº¡i'] || 0} PhÃ¡ Hoáº¡i, ${counts['Quan SÃ¡t'] || 0} Quan SÃ¡t.`); data.results.messages.forEach(msg => logMessage('info', msg)); data.players.forEach(p => { const card = document.getElementById(`player-card-${p.id}`); if (card) { const change = data.results.scoreChanges[p.id] || 0; if (change > 0) { playSound('success.mp3'); logMessage('success', `ğŸ‘ ${p.name} nháº­n Ä‘Æ°á»£c +${change} Tiáº¿n Äá»™.`); } else if (change < 0) { playSound('error.mp3'); logMessage('error', `ğŸ‘ ${p.name} máº¥t ${change} Tiáº¿n Äá»™.`); } const a = card.querySelector('.chosen-action'); a.textContent = `HÃ nh Ä‘á»™ng: ${p.chosenAction || 'KhÃ´ng rÃµ'}`; a.className = `chosen-action ${getChoiceClass(p.chosenAction)}`; const s = card.querySelector('.player-score'); s.textContent = p.score; s.classList.add(change > 0 ? 'score-up' : 'score-down'); setTimeout(() => s.classList.remove('score-up', 'score-down'), 1000); } }); });
socket.on('promptNextRound', () => { gameElements.actionControls.innerHTML = `<button class="skip-button" onclick="socket.emit('nextRound', state.currentRoomCode)">ÄÃªm Tiáº¿p Theo</button>`; });
socket.on('gameOver', data => { state.gamePhase = 'gameover'; gameElements.phaseTitle.textContent = 'ğŸ† CUá»˜C THÃM HIá»‚M Káº¾T THÃšC ğŸ†'; gameElements.actionControls.innerHTML = ''; let message = ''; if (data.winner) { let reasonText = `Ä‘Ã£ tÃ¬m tháº¥y Cá»• Váº­t vá»›i ${data.winner.score} Tiáº¿n Äá»™!`; if (data.winner.reason) reasonText = data.winner.reason; message = `ğŸ‰ **${data.winner.name}** ${reasonText} ğŸ‰`; } else if (data.loser) { message = `â˜ ï¸ **${data.loser.name}** Ä‘Ã£ bá»‹ Lá»i Nguyá»n nuá»‘t chá»­ng! â˜ ï¸`; } logMessage('warning', message); let finalHTML = `<h2 class="warning">${message}</h2>`; if (state.myId === state.currentHostId) { finalHTML += `<button class="skip-button" onclick="socket.emit('playAgain', state.currentRoomCode)">ThÃ¡m Hiá»ƒm Láº§n Ná»¯a</button>`; } else { finalHTML += `<p class="info">Äang chá» TrÆ°á»Ÿng ÄoÃ n báº¯t Ä‘áº§u cuá»™c thÃ¡m hiá»ƒm má»›i...</p>`; } gameElements.actionControls.innerHTML = finalHTML; });
socket.on('actionsSwapped', data => logMessage('warning', data.message));
socket.on('promptAmnesiaAction', data => { let c = '<h4>Chá»n 2 Thá»£ SÄƒn Ä‘á»ƒ yá»ƒm bÃ¹a:</h4><div class="player-selection-grid">'; data.players.forEach(p => c += `<button id="amnesia-target-${p.id}" onclick="selectAmnesiaTarget('${p.id}')">${p.name}</button>`); c += '</div><p id="amnesia-status">ÄÃ£ chá»n: (ChÆ°a ai)</p><button id="amnesia-confirm-btn" disabled>XÃ¡c nháº­n</button>'; createModal("BÃ¹a LÃº Láº«n", c); });
socket.on('playerDisconnected', data => { logMessage('error', `Thá»£ sÄƒn ${data.newName} Ä‘Ã£ máº¥t tÃ­ch trong Ä‘á»n thá».`); const c = document.getElementById(`player-card-${data.playerId}`); if (c) { c.querySelector('h3').textContent = data.newName; c.classList.add('disconnected'); } });

// --- VII. Functions Called by Inline JS ---
function sendPlayerChoice(choice) { playSound('click.mp3'); gameElements.actionControls.innerHTML = '<p class="info">ÄÃ£ hÃ nh Ä‘á»™ng... Chá» Ä‘á»£i trong bÃ³ng tá»‘i...</p>'; socket.emit('playerChoice', { roomCode: state.currentRoomCode, choice }); }
function showTargetSelection(actionType) { playSound('click.mp3'); let t = actionType === 'Váº¡ch Tráº§n' ? 'Váº¡ch Tráº§n Ai?' : 'Phá»‘i Há»£p Vá»›i Ai?'; let c = '<div class="player-selection-grid">'; state.players.forEach(p => { if (p.id !== state.myId && !p.disconnected) c += `<button onclick="requestChaosAction('${p.id}', '${actionType}')">${p.name}</button>`; }); c += '</div>'; createModal(t, c); }
function requestChaosAction(targetId, actionType) { playSound('click.mp3'); if (actionType === 'Váº¡ch Tráº§n') { let g = `<p>Báº¡n váº¡ch tráº§n <strong>${state.players.find(p=>p.id===targetId).name}</strong>. HÃ nh Ä‘á»™ng cá»§a há» lÃ :</p><button class="choice-buttons loyal" onclick="submitChallengeGuess('${targetId}', 'Giáº£i MÃ£')">Giáº£i MÃ£</button><button class="choice-buttons corrupt" onclick="submitChallengeGuess('${targetId}', 'PhÃ¡ Hoáº¡i')">PhÃ¡ Hoáº¡i</button><button class="choice-buttons blank" onclick="submitChallengeGuess('${targetId}', 'Quan SÃ¡t')">Quan SÃ¡t</button>`; createModal("ÄÆ°a Ra CÃ¡o Buá»™c", g); } else { socket.emit('requestChaosAction', { roomCode: state.currentRoomCode, targetId, actionType: 'Phá»‘i Há»£p' }); closeModal(); } }
function submitChallengeGuess(targetId, guess) { playSound('click.mp3'); socket.emit('requestChaosAction', { roomCode: state.currentRoomCode, targetId, actionType: 'Váº¡ch Tráº§n', guess }); closeModal(); }
function voteToSkipChaos() { playSound('click.mp3'); socket.emit('playerVotedToSkip', state.currentRoomCode); const b = document.getElementById('skip-chaos-btn'); if (b) { b.disabled = true; b.textContent = 'ÄÃ£ bá» phiáº¿u...'; } }
function kickPlayer(playerId) { if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n trá»¥c xuáº¥t Thá»£ SÄƒn nÃ y khá»i Ä‘oÃ n?")) socket.emit('kickPlayer', { roomCode: state.currentRoomCode, playerId }); }
function selectAmnesiaTarget(playerId) { playSound('click.mp3'); if (!window.specialSelection) window.specialSelection = []; const i = window.specialSelection.indexOf(playerId); if (i > -1) { window.specialSelection.splice(i, 1); document.getElementById(`amnesia-target-${playerId}`).classList.remove('selected'); } else if (window.specialSelection.length < 2) { window.specialSelection.push(playerId); document.getElementById(`amnesia-target-${playerId}`).classList.add('selected'); } document.getElementById('amnesia-status').textContent = `ÄÃ£ chá»n: ${window.specialSelection.map(id => state.players.find(p=>p.id===id).name).join(', ') || '(ChÆ°a ai)'}`; const b = document.getElementById('amnesia-confirm-btn'); b.disabled = window.specialSelection.length !== 2; b.onclick = () => { socket.emit('amnesiaAction', { roomCode: state.currentRoomCode, player1Id: window.specialSelection[0], player2Id: window.specialSelection[1] }); closeModal(); delete window.specialSelection; }; }